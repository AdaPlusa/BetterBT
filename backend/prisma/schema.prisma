generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           Int            @id @default(autoincrement())
  email        String         @unique
  password     String
  firstName    String?
  lastName     String?
  roleId       Int
  role         Role           @relation(fields: [roleId], references: [id])
  departmentId Int?
  department   Department?    @relation(fields: [departmentId], references: [id])
  trips        BusinessTrip[]
  logs         SystemLog[]
}

model Role {
  id          Int          @id @default(autoincrement())
  name        String
  users       User[]
  permissions RolePermission[]
}

model Permission {
  id          Int              @id @default(autoincrement())
  name        String
  roles       RolePermission[]
}


model RolePermission {
  id           Int        @id @default(autoincrement())
  roleId       Int
  role         Role       @relation(fields: [roleId], references: [id])
  permissionId Int
  permission   Permission @relation(fields: [permissionId], references: [id])
}

model Department {
  id    Int    @id @default(autoincrement())
  name  String
  users User[]
}

model UserPreferences {
  id        Int     @id @default(autoincrement())
  userId    Int     @unique
  theme     String  @default("light")
  language  String  @default("pl")
}

// --- MODUŁ 2: DELEGACJE (CORE) (8 tabel) ---

model BusinessTrip {
  id             Int                  @id @default(autoincrement())
  userId         Int
  user           User                 @relation(fields: [userId], references: [id])
  statusId       Int
  status         TripStatus           @relation(fields: [statusId], references: [id])
  typeId         Int
  type           TripType             @relation(fields: [typeId], references: [id])
  startDate      DateTime
  endDate        DateTime
  purpose        String
  destinationId  Int
  destination    City                 @relation(fields: [destinationId], references: [id])
  transports     TransportBooking[]
  accommodations AccommodationBooking[]
  expenseReport  ExpenseReport?
  estimatedCost  Decimal?
  rejectionReason String?
}

model TripStatus {
  id    Int            @id @default(autoincrement())
  name  String
  trips BusinessTrip[]
}

model TripType {
  id    Int            @id @default(autoincrement())
  name  String
  trips BusinessTrip[]
}

model TransportBooking {
  id          Int             @id @default(autoincrement())
  tripId      Int
  trip        BusinessTrip    @relation(fields: [tripId], references: [id])
  providerId  Int
  provider    TransportProvider @relation(fields: [providerId], references: [id])
  typeId      Int
  type        TransportType   @relation(fields: [typeId], references: [id])
  cost        Decimal
}


model TransportProvider {
  id       Int                @id @default(autoincrement())
  name     String
  typeId   Int?
  type     TransportType?     @relation(fields: [typeId], references: [id])
  bookings TransportBooking[]
  routes   TransportRoute[]   // Relacja do cennika
}

model TransportType {
  id       Int                @id @default(autoincrement())
  name     String
  bookings TransportBooking[]
  providers TransportProvider[]
  routes    TransportRoute[]
}

model TransportRoute {
  id                Int             @id @default(autoincrement())
  originCityId      Int
  originCity        City            @relation("RouteOrigin", fields: [originCityId], references: [id])
  destinationCityId Int
  destinationCity   City            @relation("RouteDestination", fields: [destinationCityId], references: [id])
  transportTypeId   Int
  transportType     TransportType   @relation(fields: [transportTypeId], references: [id])
  providerId        Int
  provider          TransportProvider @relation(fields: [providerId], references: [id])
  price             Decimal
  currency          String          @default("PLN")
}

model AccommodationBooking {
  id       Int          @id @default(autoincrement())
  tripId   Int
  trip     BusinessTrip @relation(fields: [tripId], references: [id])
  hotelId  Int
  hotel    Hotel        @relation(fields: [hotelId], references: [id])
  checkIn  DateTime
  checkOut DateTime
}

model Hotel {
  id       Int                    @id @default(autoincrement())
  name     String
  imageUrl String?
  price    Decimal                @default(250)
  cityId   Int
  city     City                   @relation(fields: [cityId], references: [id])
  bookings AccommodationBooking[]
}

// --- MODUŁ 3: SŁOWNIKI I LOKALIZACJA (6 tabel) ---

model Country {
  id        Int    @id @default(autoincrement())
  name      String
  code      String
  continent String?
  perDiemRate Decimal @default(45)
  cities    City[]
}

model City {
  id        Int            @id @default(autoincrement())
  name      String
  countryId Int
  country   Country        @relation(fields: [countryId], references: [id])
  hotels    Hotel[]
  trips     BusinessTrip[]
  originRoutes      TransportRoute[] @relation("RouteOrigin")
  destinationRoutes TransportRoute[] @relation("RouteDestination")
}

model Currency {
  id            Int            @id @default(autoincrement())
  code          String
  name          String
  exchangeRates ExchangeRate[]
}

model ExchangeRate {
  id         Int      @id @default(autoincrement())
  currencyId Int
  currency   Currency @relation(fields: [currencyId], references: [id])
  date       DateTime
  rate       Decimal
}

model VatRate {
  id    Int     @id @default(autoincrement())
  rate  Int
  label String
}

model DietRate {
  id        Int     @id @default(autoincrement())
  countryId Int
  amount    Decimal
  currency  String
}

// --- MODUŁ 4: ROZLICZENIA (6 tabel) ---

model ExpenseReport {
  id          Int           @id @default(autoincrement())
  tripId      Int           @unique
  trip        BusinessTrip  @relation(fields: [tripId], references: [id])
  totalAmount Decimal
  status      String
  items       ExpenseItem[]
}

model ExpenseItem {
  id         Int             @id @default(autoincrement())
  reportId   Int
  report     ExpenseReport   @relation(fields: [reportId], references: [id])
  categoryId Int
  category   ExpenseCategory @relation(fields: [categoryId], references: [id])
  amount     Decimal
  date       DateTime
  description String?
  payer      String?         // 'employer' or 'employee'
  receiptId  Int?            @unique
  receipt    Receipt?        @relation(fields: [receiptId], references: [id])
}

model ExpenseCategory {
  id    Int           @id @default(autoincrement())
  name  String
  items ExpenseItem[]
}

model Receipt {
  id          Int          @id @default(autoincrement())
  fileName    String
  fileUrl     String
  uploadedAt  DateTime     @default(now())
  expenseItem ExpenseItem?
}

// --- MODUŁ 5: SYSTEM I LOGI (4 tabele) ---

model SystemLog {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  action    String
  timestamp DateTime @default(now())
}

model ErrorLog {
  id        Int      @id @default(autoincrement())
  message   String
  stack     String?
  timestamp DateTime @default(now())
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
}


model AppSetting {
  id    Int    @id @default(autoincrement())
  key   String @unique
  value String
}

// --- MODUŁ 6: SZABLONY DOKUMENTÓW ---
model DocumentTemplate {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  content   String
  updatedAt DateTime @updatedAt
}